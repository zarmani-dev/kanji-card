<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á€€á€¬á€¸á€•á€«á€€á€„á€ºá€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯á€…á€”á€…á€º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Padauk:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Padauk', sans-serif;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">á€€á€¬á€¸á€•á€«á€€á€„á€ºá€™á€¾á€á€ºá€á€™á€ºá€¸á€…á€”á€…á€º</h1>
            <p class="text-gray-600 mt-2">á€œá€€á€ºá€›á€¾á€­á€”á€¾á€„á€·á€º á€šá€á€„á€ºá€€á€¬á€¸á€•á€«á€€á€„á€ºá€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€»á€¬á€¸á€€á€­á€¯ á€…á€®á€™á€¶á€•á€«á‹</p>
        </header>

        <main>
            <!-- Input Form Card -->
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">á€€á€¬á€¸á€¡á€á€…á€ºá€á€„á€ºá€›á€”á€º</h2>
                <div class="flex flex-col sm:flex-row gap-4 items-end">
                    <div class="w-full sm:flex-grow">
                        <label for="carNumber" class="block text-sm font-medium text-gray-700 mb-1">á€€á€¬á€¸á€”á€¶á€•á€«á€á€º</label>
                        <input type="text" id="carNumber" placeholder="á€¥á€•á€™á€¬ ABC-1234" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
                    </div>
                    <div class="w-full sm:w-auto">
                        <button id="addCarBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out shadow-sm">
                            á€€á€¬á€¸á€‘á€Šá€·á€ºá€›á€”á€º
                        </button>
                    </div>
                </div>
                <p id="error-message" class="text-red-500 text-sm mt-2 h-4"></p>
            </div>

            <!-- Currently Parked Section -->
            <div class="mb-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">á€œá€€á€ºá€›á€¾á€­á€•á€«á€€á€„á€ºá€‘á€­á€¯á€¸á€‘á€¬á€¸á€á€±á€¬á€€á€¬á€¸á€™á€»á€¬á€¸</h2>
                <div class="mb-4">
                     <label for="searchInput" class="sr-only">á€€á€¬á€¸á€›á€¾á€¬á€›á€”á€º</label>
                     <input type="text" id="searchInput" placeholder="ğŸ” á€€á€¬á€¸á€”á€¶á€•á€«á€á€ºá€–á€¼á€„á€·á€ºá€›á€¾á€¬á€›á€”á€º..." class="w-full max-w-md px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div id="currentlyParkedList" class="space-y-4">
                    <!-- Active cars will be dynamically added here -->
                </div>
                <div id="no-parked-cars-message" class="text-center py-10 hidden">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">á€œá€€á€ºá€›á€¾á€­á€•á€«á€€á€„á€ºá€‘á€­á€¯á€¸á€‘á€¬á€¸á€á€±á€¬á€€á€¬á€¸á€™á€›á€¾á€­á€•á€«</h3>
                    <p class="mt-1 text-sm text-gray-500">á€¡á€•á€±á€«á€ºá€€á€–á€±á€¬á€„á€ºá€€á€­á€¯á€á€¯á€¶á€¸á€•á€¼á€®á€¸ á€€á€¬á€¸á€¡á€á€…á€ºá€‘á€Šá€·á€ºá€•á€«á‹</p>
                </div>
            </div>

            <!-- Parking History Section -->
            <div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">á€•á€«á€€á€„á€ºá€™á€¾á€á€ºá€á€™á€ºá€¸</h2>
                <div id="parkingHistoryList" class="space-y-4">
                    <!-- Past records will be dynamically added here -->
                </div>
                 <div id="no-history-message" class="text-center py-10 hidden">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">á€•á€«á€€á€„á€ºá€™á€¾á€á€ºá€á€™á€ºá€¸á€™á€›á€¾á€­á€•á€«</h3>
                    <p class="mt-1 text-sm text-gray-500">á€‘á€½á€€á€ºá€á€½á€¬á€¸á€á€±á€¬á€€á€¬á€¸á€™á€»á€¬á€¸á€¤á€”á€±á€›á€¬á€á€½á€„á€ºá€•á€±á€«á€ºá€œá€¬á€•á€«á€™á€Šá€ºá‹</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop opacity-0">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md modal-content transform scale-95">
            <h2 class="text-2xl font-bold mb-4 text-gray-900">á€‘á€½á€€á€ºá€á€½á€¬á€™á€¾á€¯á€¡á€á€Šá€ºá€•á€¼á€¯á€›á€”á€º</h2>
            <div class="space-y-3">
                <p class="text-lg"><span class="font-semibold text-gray-700">á€€á€¬á€¸á€”á€¶á€•á€«á€á€º:</span> <span id="modalCarNumber" class="font-bold"></span></p>
                <p class="text-lg"><span class="font-semibold text-gray-700">á€•á€«á€€á€„á€ºá€‘á€­á€¯á€¸á€á€Šá€·á€ºá€€á€¼á€¬á€á€»á€­á€”á€º:</span> <span id="modalTimeParked"></span></p>
                <p class="text-2xl font-bold"><span class="font-semibold text-gray-700">á€á€½á€€á€ºá€á€»á€€á€ºá€‘á€¬á€¸á€á€±á€¬á€€á€»á€á€„á€·á€ºá€„á€½á€±:</span> <span id="modalTotalFee" class="text-indigo-600"></span></p>
                <p class="text-xs text-gray-500">á€•á€«á€€á€„á€ºá€”á€¾á€¯á€”á€ºá€¸ - á€á€…á€ºá€”á€¬á€›á€®á€œá€»á€¾á€„á€º á‚á€ á€˜á€á€º (á€¡á€”á€®á€¸á€…á€•á€ºá€†á€¯á€¶á€¸)á‹</p>
            </div>
            <div class="mt-6">
                <label for="manualAmount" class="block text-sm font-medium text-gray-700">á€€á€­á€¯á€šá€ºá€á€­á€¯á€„á€ºá€„á€½á€±á€•á€±á€¸á€á€»á€±á€™á€¾á€¯á€•á€™á€¬á€ (á€‘á€Šá€·á€ºá€á€»á€„á€ºá€™á€¾á€‘á€Šá€·á€ºá€•á€«)</label>
                <input type="number" id="manualAmount" placeholder="á€€á€»á€á€„á€·á€ºá€„á€½á€±á€€á€­á€¯ á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€œá€­á€¯á€•á€«á€€ á€•á€™á€¬á€á€‘á€Šá€·á€ºá€•á€«" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" min="0">
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button id="cancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300 transition">á€•á€šá€ºá€–á€»á€€á€ºá€™á€Šá€º</button>
                <button id="confirmPayBtn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition">á€„á€½á€±á€•á€±á€¸á€á€»á€±á€™á€¾á€¯á€¡á€á€Šá€ºá€•á€¼á€¯á€•á€«</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const carNumberInput = document.getElementById('carNumber');
            const addCarBtn = document.getElementById('addCarBtn');
            const searchInput = document.getElementById('searchInput');
            const currentlyParkedList = document.getElementById('currentlyParkedList');
            const parkingHistoryList = document.getElementById('parkingHistoryList');
            const errorMessage = document.getElementById('error-message');
            const noParkedMessage = document.getElementById('no-parked-cars-message');
            const noHistoryMessage = document.getElementById('no-history-message');

            const paymentModal = document.getElementById('paymentModal');
            const modalContent = paymentModal.querySelector('.modal-content');
            const cancelBtn = document.getElementById('cancelBtn');
            const confirmPayBtn = document.getElementById('confirmPayBtn');

            const PARKING_RATE_PER_HOUR = 20; // 20 Baht per hour
            const CURRENCY_SYMBOL = 'á€˜á€á€º';
            let allCars = [];
            let carToCheckOut = null;

            // --- DATA & STORAGE ---
            function loadFromStorage() {
                const storedCars = localStorage.getItem('parkingRecords');
                allCars = storedCars ? JSON.parse(storedCars) : [];
                renderLists();
            }

            function saveToStorage() {
                localStorage.setItem('parkingRecords', JSON.stringify(allCars));
            }

            // --- RENDERING & UI ---
            function formatElapsedTime(entryTime) {
                const now = new Date();
                const entry = new Date(entryTime);
                let seconds = Math.floor((now - entry) / 1000);
                
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = Math.floor(seconds % 60).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            }
            
             function formatTotalDuration(entryTime, exitTime) {
                const entry = new Date(entryTime);
                const exit = new Date(exitTime);
                let seconds = Math.floor((exit - entry) / 1000);

                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                
                let duration = '';
                if (h > 0) duration += `${h} á€”á€¬á€›á€® `;
                if (m > 0) duration += `${m} á€™á€­á€”á€…á€º`;
                if (h === 0 && m === 0) duration = '< á á€™á€­á€”á€…á€º';
                
                return duration.trim();
            }

            function renderLists() {
                currentlyParkedList.innerHTML = '';
                parkingHistoryList.innerHTML = '';
                
                const searchTerm = searchInput.value.trim().toUpperCase();

                const parkedCars = allCars.filter(c => c.status === 'parked');
                const historyCars = allCars.filter(c => c.status === 'paid').sort((a,b) => new Date(b.exitTime) - new Date(a.exitTime));

                // Render currently parked
                const filteredParkedCars = parkedCars.filter(c => c.number.includes(searchTerm));
                
                noParkedMessage.style.display = filteredParkedCars.length === 0 ? 'block' : 'none';
                
                filteredParkedCars.forEach(car => {
                    const carCard = document.createElement('div');
                    carCard.className = 'bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500';
                    const entryTime = new Date(car.entryTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    carCard.innerHTML = `
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <div>
                                <p class="text-xl font-bold text-gray-800">${car.number}</p>
                                <p class="text-sm text-gray-500">á€á€„á€ºá€›á€±á€¬á€€á€ºá€á€Šá€·á€ºá€¡á€á€»á€­á€”á€º: ${entryTime}</p>
                            </div>
                            <div class="flex items-center gap-6">
                                <div class="text-center">
                                    <p class="text-lg font-semibold text-gray-800" data-entry-time="${car.entryTime}">
                                        ${formatElapsedTime(car.entryTime)}
                                    </p>
                                    <p class="text-xs text-gray-500">á€€á€¼á€¬á€™á€¼á€„á€·á€ºá€á€»á€­á€”á€º</p>
                                </div>
                                <button class="checkout-btn bg-green-100 text-green-700 hover:bg-green-200 font-semibold py-2 px-4 rounded-lg transition" data-id="${car.id}">
                                    á€„á€½á€±á€•á€±á€¸á€á€»á€±á€•á€¼á€®á€¸á€‘á€½á€€á€ºá€á€½á€¬á€›á€”á€º
                                </button>
                            </div>
                        </div>`;
                    currentlyParkedList.appendChild(carCard);
                });
                
                // Render history
                noHistoryMessage.style.display = historyCars.length === 0 ? 'block' : 'none';
                
                historyCars.forEach(car => {
                    const carCard = document.createElement('div');
                    carCard.className = 'bg-white p-5 rounded-xl shadow-md border-l-4 border-gray-400 opacity-90';
                    const entryTime = new Date(car.entryTime).toLocaleString();
                    const exitTime = new Date(car.exitTime).toLocaleString();
                    const feeText = `${car.fee.toFixed(2)} ${CURRENCY_SYMBOL} ${car.manualPayment ? '<span class="text-xs text-gray-500 font-normal">(á€€á€­á€¯á€šá€ºá€á€­á€¯á€„á€º)</span>' : ''}`;
                    carCard.innerHTML = `
                         <div class="flex flex-wrap items-center justify-between gap-4">
                            <div>
                                <p class="text-xl font-bold text-gray-600">${car.number}</p>
                                <p class="text-sm text-gray-500">á€á€„á€º: ${entryTime} | á€‘á€½á€€á€º: ${exitTime}</p>
                            </div>
                            <div class="text-right">
                                 <p class="text-lg font-semibold text-gray-800">${feeText}</p>
                                 <p class="text-sm text-gray-500">á€€á€¼á€¬á€á€»á€­á€”á€º: ${formatTotalDuration(car.entryTime, car.exitTime)}</p>
                            </div>
                        </div>`;
                    parkingHistoryList.appendChild(carCard);
                });
            }
            
            setInterval(() => {
                document.querySelectorAll('[data-entry-time]').forEach(el => {
                    el.textContent = formatElapsedTime(el.dataset.entryTime);
                });
            }, 1000);

            // --- CORE LOGIC ---
            function addCar() {
                const carNumber = carNumberInput.value.trim().toUpperCase();
                if (!carNumber) {
                    errorMessage.textContent = 'á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€€á€¬á€¸á€”á€¶á€•á€«á€á€ºá€‘á€Šá€·á€ºá€•á€«á‹';
                    return;
                }
                if (allCars.some(c => c.number === carNumber && c.status === 'parked')) {
                    errorMessage.textContent = 'á€¤á€€á€¬á€¸á€á€Šá€º á€•á€«á€€á€„á€ºá€‘á€²á€á€½á€„á€ºá€›á€¾á€­á€”á€±á€•á€¼á€®á€¸á€á€¬á€¸á€–á€¼á€…á€ºá€á€Šá€ºá‹';
                    return;
                }
                errorMessage.textContent = '';

                const newCar = {
                    id: Date.now(),
                    number: carNumber,
                    entryTime: new Date().toISOString(),
                    status: 'parked',
                    exitTime: null,
                    fee: null,
                    manualPayment: false
                };
                allCars.push(newCar);
                saveToStorage();
                renderLists();
                carNumberInput.value = '';
                carNumberInput.focus();
            }
            
            function calculateFee(entryTime) {
                const now = new Date();
                const entry = new Date(entryTime);
                const minutesParked = (now - entry) / (1000 * 60);
                
                if (minutesParked <= 0) return PARKING_RATE_PER_HOUR;

                const hoursToCharge = Math.ceil(minutesParked / 60);
                const fee = hoursToCharge * PARKING_RATE_PER_HOUR;
                return fee;
            }

            // --- MODAL HANDLING ---
            function openPaymentModal(carId) {
                carToCheckOut = allCars.find(c => c.id === carId);
                if (!carToCheckOut) return;
                
                const fee = calculateFee(carToCheckOut.entryTime);
                
                document.getElementById('modalCarNumber').textContent = carToCheckOut.number;
                document.getElementById('modalTimeParked').textContent = formatElapsedTime(carToCheckOut.entryTime);
                document.getElementById('modalTotalFee').textContent = `${fee.toFixed(2)} ${CURRENCY_SYMBOL}`;
                document.getElementById('manualAmount').value = '';
                
                paymentModal.classList.remove('hidden');
                setTimeout(() => {
                    paymentModal.classList.remove('opacity-0');
                    modalContent.classList.remove('scale-95');
                }, 10);
            }
            
            function closePaymentModal() {
                 paymentModal.classList.add('opacity-0');
                 modalContent.classList.add('scale-95');
                 setTimeout(() => {
                    paymentModal.classList.add('hidden');
                    carToCheckOut = null;
                }, 300);
            }

            function confirmPayment() {
                if (!carToCheckOut) return;

                const manualAmountInput = document.getElementById('manualAmount');
                const manualAmount = parseFloat(manualAmountInput.value);
                
                let finalFee;
                let isManual = false;

                if (!isNaN(manualAmount) && manualAmount >= 0 && manualAmountInput.value.trim() !== '') {
                    finalFee = manualAmount;
                    isManual = true;
                } else {
                    finalFee = calculateFee(carToCheckOut.entryTime);
                }

                carToCheckOut.status = 'paid';
                carToCheckOut.exitTime = new Date().toISOString();
                carToCheckOut.fee = finalFee;
                carToCheckOut.manualPayment = isManual;

                saveToStorage();
                renderLists();
                closePaymentModal();
            }

            // --- EVENT LISTENERS ---
            addCarBtn.addEventListener('click', addCar);
            carNumberInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') addCar();
            });
            searchInput.addEventListener('input', renderLists);
            
            currentlyParkedList.addEventListener('click', e => {
                const checkoutBtn = e.target.closest('.checkout-btn');
                if (checkoutBtn) {
                    const carId = parseInt(checkoutBtn.dataset.id, 10);
                    openPaymentModal(carId);
                }
            });

            confirmPayBtn.addEventListener('click', confirmPayment);
            cancelBtn.addEventListener('click', closePaymentModal);
            paymentModal.addEventListener('click', e => {
                if (e.target === paymentModal) {
                    closePaymentModal();
                }
            });

            // Initial Load
            loadFromStorage();
        });
    </script>
</body>
</html>

